from typing import Dict, Any, List
import random


class TemplateService:
    """社交行为建议模板库：为不同场景提供固定策略模板"""
    
    def __init__(self):
        self.templates = {
            "拒绝": {
                "simple_explanation": "对方是在礼貌地拒绝你。",
                "why": "他想保持关系，但现在不想继续或无法满足你的要求。",
                "suggestions": [
                    "步骤1：说'好的，没关系'，表示理解",
                    "步骤2：不要继续追问原因",
                    "步骤3：可以转换话题或结束对话",
                    "步骤4：保持友好态度，不要表现出不满"
                ],
                "do_not": [
                    "不要追问'为什么不行'",
                    "不要表现出生气或失望",
                    "不要强迫对方改变决定"
                ],
                "examples": [
                    "算了，不用了",
                    "改天吧",
                    "下次再说",
                    "不用麻烦了",
                    "以后有机会再聊"
                ]
            },
            "冲突": {
                "simple_explanation": "对方可能对某些事情感到不满或生气。",
                "why": "可能是之前的某些行为或话语让对方感到不舒服。",
                "suggestions": [
                    "步骤1：保持冷静，不要立即反驳",
                    "步骤2：说'我理解你的感受'，表示尊重",
                    "步骤3：询问'我哪里做得不对吗？'，了解原因",
                    "步骤4：如果对方情绪激动，可以暂时离开，稍后再沟通"
                ],
                "do_not": [
                    "不要立即争吵或反驳",
                    "不要忽视对方的情绪",
                    "不要用激烈的语言回应"
                ],
                "examples": [
                    "烦死了",
                    "又这样",
                    "够了，别说了",
                    "走开",
                    "真讨厌"
                ]
            },
            "暗示": {
                "simple_explanation": "对方在间接表达想法，没有直接说明。",
                "why": "他可能不想直接拒绝或提出要求，用委婉的方式表达。",
                "suggestions": [
                    "步骤1：注意对方说话的语气和用词",
                    "步骤2：可以询问'你的意思是...？'来确认理解",
                    "步骤3：如果不确定，可以等待更明确的表达",
                    "步骤4：尊重对方的表达方式，不要强迫直接说明"
                ],
                "do_not": [
                    "不要过度解读或猜测",
                    "不要强迫对方直接说明",
                    "不要忽视暗示，完全按字面理解"
                ]
            },
            "情绪": {
                "simple_explanation": "对方在表达自己的情感状态。",
                "why": "他可能想分享感受，或需要情感支持。",
                "suggestions": [
                    "步骤1：认真倾听，表示关注",
                    "步骤2：可以用'我理解'或'我明白'回应",
                    "步骤3：如果对方难过，可以问'需要我做什么吗？'",
                    "步骤4：给予适当的安慰或支持"
                ],
                "do_not": [
                    "不要忽视或轻视对方的情绪",
                    "不要立即给出建议或解决方案",
                    "不要转移话题"
                ]
            },
            "请求": {
                "simple_explanation": "对方在向你提出要求或请求帮助。",
                "why": "他需要你的帮助或希望你能做某些事情。",
                "suggestions": [
                    "步骤1：仔细听清楚对方的要求",
                    "步骤2：如果可以，说'好的，我来帮你'",
                    "步骤3：如果不行，礼貌地说'抱歉，我现在不方便'",
                    "步骤4：如果不确定，可以说'让我想想'或'我需要考虑一下'"
                ],
                "do_not": [
                    "不要立即拒绝，先理解对方的需求",
                    "不要承诺做不到的事情",
                    "不要忽视对方的请求"
                ]
            },
            "赞美": {
                "simple_explanation": "对方在表扬或肯定你。",
                "why": "他对你的表现或行为感到满意和赞赏。",
                "suggestions": [
                    "步骤1：说'谢谢'，表示接受",
                    "步骤2：可以回应'我很高兴'或'我会继续努力'",
                    "步骤3：不要过度谦虚或否定自己",
                    "步骤4：保持友好和积极的态度"
                ],
                "do_not": [
                    "不要完全否定对方的赞美",
                    "不要表现得过于骄傲",
                    "不要忽视对方的善意"
                ]
            },
            "批评": {
                "simple_explanation": "对方在指出问题或表达不满。",
                "why": "他认为某些方面需要改进或有问题。",
                "suggestions": [
                    "步骤1：保持冷静，认真听取",
                    "步骤2：说'我明白了'或'我会注意'",
                    "步骤3：如果确实有问题，可以道歉'对不起，我会改进'",
                    "步骤4：询问具体如何改进"
                ],
                "do_not": [
                    "不要立即反驳或辩解",
                    "不要忽视批评",
                    "不要表现出过度的防御"
                ]
            },
            "请求帮助": {
                "simple_explanation": "对方在请求你的帮助。",
                "why": "他需要你的协助来完成某些事情。",
                "suggestions": [
                    "步骤1：仔细听清楚对方需要什么帮助",
                    "步骤2：如果可以，说'好的，我来帮你'",
                    "步骤3：如果不行，礼貌地说明原因",
                    "步骤4：提供力所能及的帮助"
                ],
                "do_not": [
                    "不要立即拒绝",
                    "不要承诺做不到的事情",
                    "不要忽视对方的请求"
                ]
            },
            "提出改进建议": {
                "simple_explanation": "对方在提出改进建议。",
                "why": "他希望某些方面可以做得更好。",
                "suggestions": [
                    "步骤1：认真听取建议",
                    "步骤2：说'谢谢你的建议'",
                    "步骤3：考虑建议的可行性",
                    "步骤4：可以询问更多细节"
                ],
                "do_not": [
                    "不要立即拒绝建议",
                    "不要表现出防御态度",
                    "不要忽视建议"
                ]
            },
            "失望": {
                "simple_explanation": "对方感到失望。",
                "why": "某些事情没有达到他的期望。",
                "suggestions": [
                    "步骤1：理解对方的感受",
                    "步骤2：可以说'我理解你的失望'",
                    "步骤3：询问是否可以做什么来改善",
                    "步骤4：给予适当的安慰"
                ],
                "do_not": [
                    "不要轻视对方的失望",
                    "不要立即给出解决方案",
                    "不要转移话题"
                ]
            },
            "无聊": {
                "simple_explanation": "对方感到无聊。",
                "why": "他可能觉得当前活动或对话没有意思。",
                "suggestions": [
                    "步骤1：理解对方的感受",
                    "步骤2：可以询问'你想做什么？'",
                    "步骤3：可以提议其他活动",
                    "步骤4：尊重对方的选择"
                ],
                "do_not": [
                    "不要强迫对方继续",
                    "不要忽视对方的感受",
                    "不要表现出不满"
                ]
            },
            "高兴": {
                "simple_explanation": "对方感到高兴。",
                "why": "某些事情让他感到开心和满足。",
                "suggestions": [
                    "步骤1：分享对方的快乐",
                    "步骤2：可以说'太好了'或'真为你高兴'",
                    "步骤3：可以询问'发生了什么好事？'",
                    "步骤4：保持积极和友好的态度"
                ],
                "do_not": [
                    "不要泼冷水",
                    "不要转移话题",
                    "不要忽视对方的快乐"
                ]
            },
            "尴尬": {
                "simple_explanation": "对方感到尴尬。",
                "why": "某些情况让他感到不自在或难为情。",
                "suggestions": [
                    "步骤1：理解对方的感受",
                    "步骤2：可以转换话题",
                    "步骤3：可以说'没关系'来缓解",
                    "步骤4：不要过度关注尴尬的情况"
                ],
                "do_not": [
                    "不要继续讨论尴尬的话题",
                    "不要嘲笑或取笑",
                    "不要忽视对方的感受"
                ]
            },
            "恐惧": {
                "simple_explanation": "对方感到害怕或恐惧。",
                "why": "某些事情让他感到不安或担心。",
                "suggestions": [
                    "步骤1：认真倾听，表示理解",
                    "步骤2：可以说'我理解你的担心'",
                    "步骤3：询问具体担心什么",
                    "步骤4：提供适当的安慰和支持"
                ],
                "do_not": [
                    "不要轻视对方的恐惧",
                    "不要强迫对方面对恐惧",
                    "不要忽视对方的感受"
                ]
            },
            "惊讶": {
                "simple_explanation": "对方感到惊讶。",
                "why": "某些事情出乎他的意料。",
                "suggestions": [
                    "步骤1：理解对方的反应",
                    "步骤2：可以询问'怎么了？'",
                    "步骤3：可以解释或说明情况",
                    "步骤4：保持友好和耐心"
                ],
                "do_not": [
                    "不要忽视对方的反应",
                    "不要过度解释",
                    "不要表现出不耐烦"
                ]
            },
            "回应感谢": {
                "simple_explanation": "对方在感谢你。",
                "why": "他对你的帮助或行为表示感谢。",
                "suggestions": [
                    "步骤1：接受感谢",
                    "步骤2：可以说'不客气'或'很高兴能帮到你'",
                    "步骤3：保持友好和谦逊",
                    "步骤4：可以回应'如果还有需要，随时告诉我'"
                ],
                "do_not": [
                    "不要过度谦虚",
                    "不要忽视对方的感谢",
                    "不要表现得过于骄傲"
                ]
            },
            "安慰": {
                "simple_explanation": "对方在安慰你。",
                "why": "他注意到你可能需要情感支持。",
                "suggestions": [
                    "步骤1：接受对方的安慰",
                    "步骤2：可以说'谢谢你的关心'",
                    "步骤3：可以分享你的感受",
                    "步骤4：保持开放和信任"
                ],
                "do_not": [
                    "不要拒绝对方的善意",
                    "不要完全封闭自己",
                    "不要忽视对方的关心"
                ]
            },
            "抱怨": {
                "simple_explanation": "对方在抱怨某些事情。",
                "why": "他对某些情况感到不满或困扰。",
                "suggestions": [
                    "步骤1：认真倾听",
                    "步骤2：可以说'我理解你的困扰'",
                    "步骤3：可以询问具体情况",
                    "步骤4：可以提供建议或支持"
                ],
                "do_not": [
                    "不要立即反驳",
                    "不要忽视对方的抱怨",
                    "不要表现出不耐烦"
                ]
            }
        }
    
    def get_template(self, scene: str) -> Dict[str, Any]:
        """获取指定场景的模板"""
        template = self.templates.get(scene, {
            "simple_explanation": "这是一个普通的社交交流。",
            "why": "对方在与你正常交流。",
            "suggestions": [
                "步骤1：保持友好和尊重",
                "步骤2：认真倾听",
                "步骤3：适当回应"
            ],
            "do_not": [],
            "examples": []
        })
        # 确保所有模板都有 examples 字段
        if "examples" not in template:
            template["examples"] = []
        return template
    
    def get_examples(self, scene: str, limit: int = 5) -> List[str]:
        """获取场景的示例文本"""
        template = self.get_template(scene)
        examples = template.get("examples", [])
        return examples[:limit] if limit > 0 else examples
    
    def get_all_scenes(self) -> List[str]:
        """获取所有支持的场景类型"""
        return list(self.templates.keys())
    
    def enhance_with_ai(self, template: Dict[str, Any], text: str, scene: str) -> Dict[str, Any]:
        """使用 AI 自然化处理模板，使表达更柔和但仍清晰"""
        # 如果 AI 服务可用，可以进一步优化模板表达
        # 这里先返回原模板，后续可以接入 AI 优化
        return template
    
    def get_suggestion(self, scene: str, text: str = "") -> Dict[str, Any]:
        """获取场景对应的行为建议"""
        template = self.get_template(scene)
        # 可以基于具体文本进一步定制建议
        return template















